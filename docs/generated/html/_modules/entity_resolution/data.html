<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>entity_resolution.data &mdash; Entity Resolution Kit 1.3.0 documentation</title>
      <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/doctools.js"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../../index.html" class="icon icon-home"> Entity Resolution Kit
          </a>
              <div class="version">
                1.3.0
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../readme.html">Entity Resolution Kit</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../usage.html">Usage</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../modules.html">entity_resolution</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">Entity Resolution Kit</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home"></a> &raquo;</li>
          <li><a href="../index.html">Module code</a> &raquo;</li>
      <li>entity_resolution.data</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for entity_resolution.data</h1><div class="highlight"><pre>
<span></span><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">List</span><span class="p">,</span> <span class="n">Union</span><span class="p">,</span> <span class="n">Any</span>

<span class="kn">import</span> <span class="nn">networkx</span> <span class="k">as</span> <span class="nn">nx</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">os</span><span class="o">,</span> <span class="nn">uuid</span><span class="o">,</span> <span class="nn">random</span><span class="o">,</span> <span class="nn">multiprocessing</span><span class="o">,</span> <span class="nn">json</span><span class="o">,</span> <span class="nn">glob</span><span class="o">,</span> <span class="nn">gzip</span>
<span class="kn">from</span> <span class="nn">faker</span> <span class="kn">import</span> <span class="n">Faker</span>
<span class="kn">from</span> <span class="nn">boto3.session</span> <span class="kn">import</span> <span class="n">Session</span>
<span class="kn">import</span> <span class="nn">boto3</span><span class="o">,</span> <span class="nn">uuid</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
<span class="kn">from</span> <span class="nn">urllib.parse</span> <span class="kn">import</span> <span class="n">urlparse</span>
<span class="kn">from</span> <span class="nn">tqdm</span> <span class="kn">import</span> <span class="n">tqdm</span>
<span class="kn">from</span> <span class="nn">neo4j</span> <span class="kn">import</span> <span class="n">GraphDatabase</span>

<span class="n">fake</span> <span class="o">=</span> <span class="n">Faker</span><span class="p">()</span>

<span class="n">__transform_keys</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;Device&quot;</span><span class="p">,</span> <span class="s2">&quot;IP&quot;</span><span class="p">,</span> <span class="s2">&quot;Location&quot;</span><span class="p">,</span> <span class="s2">&quot;Identity&quot;</span><span class="p">,</span> <span class="s2">&quot;Cookie&quot;</span><span class="p">]</span>
<span class="sd">&quot;&quot;&quot;The attributes of a reduced record.&quot;&quot;&quot;</span>

<span class="n">__transform_indices</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">15</span><span class="p">,</span> <span class="mi">13</span><span class="p">,</span> <span class="mi">122</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">17</span><span class="p">]</span>
<span class="sd">&quot;&quot;&quot;The indices in the raw record where the relevant data is extracted.&quot;&quot;&quot;</span>

<span class="n">__raw_keys</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s2">&quot;APP_ID&quot;</span><span class="p">,</span>
    <span class="s2">&quot;PLATFORM&quot;</span><span class="p">,</span>
    <span class="s2">&quot;ETL_TSTAMP&quot;</span><span class="p">,</span>
    <span class="s2">&quot;COLLECTOR_TSTAMP&quot;</span><span class="p">,</span>
    <span class="s2">&quot;DVCE_CREATED_TSTAMP&quot;</span><span class="p">,</span>
    <span class="s2">&quot;EVENT&quot;</span><span class="p">,</span>
    <span class="s2">&quot;EVENT_ID&quot;</span><span class="p">,</span>
    <span class="s2">&quot;TXN_ID&quot;</span><span class="p">,</span>
    <span class="s2">&quot;NAME_TRACKER&quot;</span><span class="p">,</span>
    <span class="s2">&quot;V_TRACKER&quot;</span><span class="p">,</span>
    <span class="s2">&quot;V_COLLECTOR&quot;</span><span class="p">,</span>
    <span class="s2">&quot;V_ETL&quot;</span><span class="p">,</span>
    <span class="s2">&quot;USER_ID&quot;</span><span class="p">,</span>
    <span class="s2">&quot;USER_IPADDRESS&quot;</span><span class="p">,</span>
    <span class="s2">&quot;USER_FINGERPRINT&quot;</span><span class="p">,</span>
    <span class="s2">&quot;DOMAIN_USERID&quot;</span><span class="p">,</span>
    <span class="s2">&quot;DOMAIN_SESSIONIDX&quot;</span><span class="p">,</span>
    <span class="s2">&quot;NETWORK_USERID&quot;</span><span class="p">,</span>
    <span class="s2">&quot;GEO_COUNTRY&quot;</span><span class="p">,</span>
    <span class="s2">&quot;GEO_REGION&quot;</span><span class="p">,</span>
    <span class="s2">&quot;GEO_CITY&quot;</span><span class="p">,</span>
    <span class="s2">&quot;GEO_ZIPCODE&quot;</span><span class="p">,</span>
    <span class="s2">&quot;GEO_LATITUDE&quot;</span><span class="p">,</span>
    <span class="s2">&quot;GEO_LONGITUDE&quot;</span><span class="p">,</span>
    <span class="s2">&quot;GEO_REGION_NAME&quot;</span><span class="p">,</span>
    <span class="s2">&quot;IP_ISP&quot;</span><span class="p">,</span>
    <span class="s2">&quot;IP_ORGANIZATION&quot;</span><span class="p">,</span>
    <span class="s2">&quot;IP_DOMAIN&quot;</span><span class="p">,</span>
    <span class="s2">&quot;IP_NETSPEED&quot;</span><span class="p">,</span>
    <span class="s2">&quot;PAGE_URL&quot;</span><span class="p">,</span>
    <span class="s2">&quot;PAGE_TITLE&quot;</span><span class="p">,</span>
    <span class="s2">&quot;PAGE_REFERRER&quot;</span><span class="p">,</span>
    <span class="s2">&quot;PAGE_URLSCHEME&quot;</span><span class="p">,</span>
    <span class="s2">&quot;PAGE_URLHOST&quot;</span><span class="p">,</span>
    <span class="s2">&quot;PAGE_URLPORT&quot;</span><span class="p">,</span>
    <span class="s2">&quot;PAGE_URLPATH&quot;</span><span class="p">,</span>
    <span class="s2">&quot;PAGE_URLQUERY&quot;</span><span class="p">,</span>
    <span class="s2">&quot;PAGE_URLFRAGMENT&quot;</span><span class="p">,</span>
    <span class="s2">&quot;REFR_URLSCHEME&quot;</span><span class="p">,</span>
    <span class="s2">&quot;REFR_URLHOST&quot;</span><span class="p">,</span>
    <span class="s2">&quot;REFR_URLPORT&quot;</span><span class="p">,</span>
    <span class="s2">&quot;REFR_URLPATH&quot;</span><span class="p">,</span>
    <span class="s2">&quot;REFR_URLQUERY&quot;</span><span class="p">,</span>
    <span class="s2">&quot;REFR_URLFRAGMENT&quot;</span><span class="p">,</span>
    <span class="s2">&quot;REFR_MEDIUM&quot;</span><span class="p">,</span>
    <span class="s2">&quot;REFR_SOURCE&quot;</span><span class="p">,</span>
    <span class="s2">&quot;REFR_TERM&quot;</span><span class="p">,</span>
    <span class="s2">&quot;MKT_MEDIUM&quot;</span><span class="p">,</span>
    <span class="s2">&quot;MKT_SOURCE&quot;</span><span class="p">,</span>
    <span class="s2">&quot;MKT_TERM&quot;</span><span class="p">,</span>
    <span class="s2">&quot;MKT_CONTENT&quot;</span><span class="p">,</span>
    <span class="s2">&quot;MKT_CAMPAIGN&quot;</span><span class="p">,</span>
    <span class="s2">&quot;CONTEXTS&quot;</span><span class="p">,</span>
    <span class="s2">&quot;SE_CATEGORY&quot;</span><span class="p">,</span>
    <span class="s2">&quot;SE_ACTION&quot;</span><span class="p">,</span>
    <span class="s2">&quot;SE_LABEL&quot;</span><span class="p">,</span>
    <span class="s2">&quot;SE_PROPERTY&quot;</span><span class="p">,</span>
    <span class="s2">&quot;SE_VALUE&quot;</span><span class="p">,</span>
    <span class="s2">&quot;UNSTRUCT_EVENT&quot;</span><span class="p">,</span>
    <span class="s2">&quot;TR_ORDERID&quot;</span><span class="p">,</span>
    <span class="s2">&quot;TR_AFFILIATION&quot;</span><span class="p">,</span>
    <span class="s2">&quot;TR_TOTAL&quot;</span><span class="p">,</span>
    <span class="s2">&quot;TR_TAX&quot;</span><span class="p">,</span>
    <span class="s2">&quot;TR_SHIPPING&quot;</span><span class="p">,</span>
    <span class="s2">&quot;TR_CITY&quot;</span><span class="p">,</span>
    <span class="s2">&quot;TR_STATE&quot;</span><span class="p">,</span>
    <span class="s2">&quot;TR_COUNTRY&quot;</span><span class="p">,</span>
    <span class="s2">&quot;TI_ORDERID&quot;</span><span class="p">,</span>
    <span class="s2">&quot;TI_SKU&quot;</span><span class="p">,</span>
    <span class="s2">&quot;TI_NAME&quot;</span><span class="p">,</span>
    <span class="s2">&quot;TI_CATEGORY&quot;</span><span class="p">,</span>
    <span class="s2">&quot;TI_PRICE&quot;</span><span class="p">,</span>
    <span class="s2">&quot;TI_QUANTITY&quot;</span><span class="p">,</span>
    <span class="s2">&quot;PP_XOFFSET_MIN&quot;</span><span class="p">,</span>
    <span class="s2">&quot;PP_XOFFSET_MAX&quot;</span><span class="p">,</span>
    <span class="s2">&quot;PP_YOFFSET_MIN&quot;</span><span class="p">,</span>
    <span class="s2">&quot;PP_YOFFSET_MAX&quot;</span><span class="p">,</span>
    <span class="s2">&quot;USERAGENT&quot;</span><span class="p">,</span>
    <span class="s2">&quot;BR_NAME&quot;</span><span class="p">,</span>
    <span class="s2">&quot;BR_FAMILY&quot;</span><span class="p">,</span>
    <span class="s2">&quot;BR_VERSION&quot;</span><span class="p">,</span>
    <span class="s2">&quot;BR_TYPE&quot;</span><span class="p">,</span>
    <span class="s2">&quot;BR_RENDERENGINE&quot;</span><span class="p">,</span>
    <span class="s2">&quot;BR_LANG&quot;</span><span class="p">,</span>
    <span class="s2">&quot;BR_FEATURES_PDF&quot;</span><span class="p">,</span>
    <span class="s2">&quot;BR_FEATURES_FLASH&quot;</span><span class="p">,</span>
    <span class="s2">&quot;BR_FEATURES_JAVA&quot;</span><span class="p">,</span>
    <span class="s2">&quot;BR_FEATURES_DIRECTOR&quot;</span><span class="p">,</span>
    <span class="s2">&quot;BR_FEATURES_QUICKTIME&quot;</span><span class="p">,</span>
    <span class="s2">&quot;BR_FEATURES_REALPLAYER&quot;</span><span class="p">,</span>
    <span class="s2">&quot;BR_FEATURES_WINDOWSMEDIA&quot;</span><span class="p">,</span>
    <span class="s2">&quot;BR_FEATURES_GEARS&quot;</span><span class="p">,</span>
    <span class="s2">&quot;BR_FEATURES_SILVERLIGHT&quot;</span><span class="p">,</span>
    <span class="s2">&quot;BR_COOKIES&quot;</span><span class="p">,</span>
    <span class="s2">&quot;BR_COLORDEPTH&quot;</span><span class="p">,</span>
    <span class="s2">&quot;BR_VIEWWIDTH&quot;</span><span class="p">,</span>
    <span class="s2">&quot;BR_VIEWHEIGHT&quot;</span><span class="p">,</span>
    <span class="s2">&quot;OS_NAME&quot;</span><span class="p">,</span>
    <span class="s2">&quot;OS_FAMILY&quot;</span><span class="p">,</span>
    <span class="s2">&quot;OS_MANUFACTURER&quot;</span><span class="p">,</span>
    <span class="s2">&quot;OS_TIMEZONE&quot;</span><span class="p">,</span>
    <span class="s2">&quot;DVCE_TYPE&quot;</span><span class="p">,</span>
    <span class="s2">&quot;DVCE_ISMOBILE&quot;</span><span class="p">,</span>
    <span class="s2">&quot;DVCE_SCREENWIDTH&quot;</span><span class="p">,</span>
    <span class="s2">&quot;DVCE_SCREENHEIGHT&quot;</span><span class="p">,</span>
    <span class="s2">&quot;DOC_CHARSET&quot;</span><span class="p">,</span>
    <span class="s2">&quot;DOC_WIDTH&quot;</span><span class="p">,</span>
    <span class="s2">&quot;DOC_HEIGHT&quot;</span><span class="p">,</span>
    <span class="s2">&quot;TR_CURRENCY&quot;</span><span class="p">,</span>
    <span class="s2">&quot;TR_TOTAL_BASE&quot;</span><span class="p">,</span>
    <span class="s2">&quot;TR_TAX_BASE&quot;</span><span class="p">,</span>
    <span class="s2">&quot;TR_SHIPPING_BASE&quot;</span><span class="p">,</span>
    <span class="s2">&quot;TI_CURRENCY&quot;</span><span class="p">,</span>
    <span class="s2">&quot;TI_PRICE_BASE&quot;</span><span class="p">,</span>
    <span class="s2">&quot;BASE_CURRENCY&quot;</span><span class="p">,</span>
    <span class="s2">&quot;GEO_TIMEZONE&quot;</span><span class="p">,</span>
    <span class="s2">&quot;MKT_CLICKID&quot;</span><span class="p">,</span>
    <span class="s2">&quot;MKT_NETWORK&quot;</span><span class="p">,</span>
    <span class="s2">&quot;ETL_TAGS&quot;</span><span class="p">,</span>
    <span class="s2">&quot;DVCE_SENT_TSTAMP&quot;</span><span class="p">,</span>
    <span class="s2">&quot;REFR_DOMAIN_USERID&quot;</span><span class="p">,</span>
    <span class="s2">&quot;REFR_DVCE_TSTAMP&quot;</span><span class="p">,</span>
    <span class="s2">&quot;DERIVED_CONTEXTS&quot;</span><span class="p">,</span>
    <span class="s2">&quot;DOMAIN_SESSIONID&quot;</span><span class="p">,</span>
    <span class="s2">&quot;DERIVED_TSTAMP&quot;</span><span class="p">,</span>
    <span class="s2">&quot;EVENT_VENDOR&quot;</span><span class="p">,</span>
    <span class="s2">&quot;EVENT_NAME&quot;</span><span class="p">,</span>
    <span class="s2">&quot;EVENT_FORMAT&quot;</span><span class="p">,</span>
    <span class="s2">&quot;EVENT_VERSION&quot;</span><span class="p">,</span>
    <span class="s2">&quot;EVENT_FINGERPRINT&quot;</span><span class="p">,</span>
    <span class="s2">&quot;TRUE_TSTAMP&quot;</span>
<span class="p">]</span>
<span class="sd">&quot;&quot;&quot;The field names in the raw data.&quot;&quot;&quot;</span>

<span class="n">__basic1</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;nodes&quot;</span><span class="p">:</span> <span class="p">[</span>
        <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;Identity&quot;</span><span class="p">],</span>
        <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;Device&quot;</span><span class="p">],</span>
        <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="s2">&quot;Cookie&quot;</span><span class="p">],</span>
        <span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="s2">&quot;Location&quot;</span><span class="p">],</span>
        <span class="p">[</span><span class="mi">4</span><span class="p">,</span> <span class="s2">&quot;Device&quot;</span><span class="p">],</span>
        <span class="p">[</span><span class="mi">5</span><span class="p">,</span> <span class="s2">&quot;IP&quot;</span><span class="p">],</span>
        <span class="p">[</span><span class="mi">6</span><span class="p">,</span> <span class="s2">&quot;Device&quot;</span><span class="p">],</span>
    <span class="p">],</span>
    <span class="s2">&quot;edges&quot;</span><span class="p">:</span> <span class="p">[</span>
        <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;HAS_IDENTITY&quot;</span><span class="p">],</span>
        <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="s2">&quot;HAS_COOKIE&quot;</span><span class="p">],</span>
        <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="s2">&quot;HAS_LOCATION&quot;</span><span class="p">],</span>
        <span class="p">[</span><span class="mi">4</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="s2">&quot;HAS_COOKIE&quot;</span><span class="p">],</span>
        <span class="p">[</span><span class="mi">4</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="s2">&quot;HAS_LOCATION&quot;</span><span class="p">],</span>
        <span class="p">[</span><span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="s2">&quot;HAS_IP&quot;</span><span class="p">],</span>
        <span class="p">[</span><span class="mi">6</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="s2">&quot;HAS_IP&quot;</span><span class="p">],</span>
    <span class="p">]</span>
<span class="p">}</span>
<span class="sd">&quot;&quot;&quot;Defines the structure of a basic sample graph.&quot;&quot;&quot;</span>

<span class="n">__sample_raw</span> <span class="o">=</span> <span class="s1">&#39;mymcle	web	2021-11-12 01:03:14.153	2021-11-12 01:03:13.672	2021-11-12 01:03:13.789	struct	2986f321-cbe2-48ff-860b-c72d3b0714d1		mc	js-2.16.3	ssc-2.3.0-kinesis	stream-2.0.1-common-2.0.1		122.150.112.14		48392ab4-1e81-41c2-bd48-b86a2bc713f7	1	adbacbcf-7f7d-4987-a43a-10705017ae39												https://www.mymusclechef.com/plans/muscle-gain/		https://www.mymusclechef.com/plans/	https	www.mymusclechef.com	443	/plans/muscle-gain/			https	www.mymusclechef.com	443	/plans/			internal								{&quot;schema&quot;:&quot;iglu:com.snowplowanalytics.snowplow/contexts/jsonschema/1-0-0&quot;,&quot;data&quot;:[{&quot;schema&quot;:&quot;iglu:com.mymusclechef/subject/jsonschema/1-0-1&quot;,&quot;data&quot;:{&quot;goal&quot;:&quot;Muscle Gain&quot;,&quot;gender&quot;:&quot;male&quot;}},{&quot;schema&quot;:&quot;iglu:com.snowplowanalytics.snowplow/web_page/jsonschema/1-0-0&quot;,&quot;data&quot;:{&quot;id&quot;:&quot;92f29c39-57bc-4a0b-a62e-98c73ec98fd5&quot;}},{&quot;schema&quot;:&quot;iglu:org.w3/PerformanceTiming/jsonschema/1-0-0&quot;,&quot;data&quot;:{&quot;navigationStart&quot;:1636678989713,&quot;unloadEventStart&quot;:1636678990152,&quot;unloadEventEnd&quot;:1636678990153,&quot;redirectStart&quot;:0,&quot;redirectEnd&quot;:0,&quot;fetchStart&quot;:1636678989722,&quot;domainLookupStart&quot;:1636678989722,&quot;domainLookupEnd&quot;:1636678989722,&quot;connectStart&quot;:1636678989722,&quot;connectEnd&quot;:1636678989722,&quot;secureConnectionStart&quot;:0,&quot;requestStart&quot;:1636678989726,&quot;responseStart&quot;:1636678990094,&quot;responseEnd&quot;:1636678990098,&quot;domLoading&quot;:1636678990173,&quot;domInteractive&quot;:1636678990425,&quot;domContentLoadedEventStart&quot;:1636678990461,&quot;domContentLoadedEventEnd&quot;:1636678990461,&quot;domComplete&quot;:1636678991629,&quot;loadEventStart&quot;:1636678991629,&quot;loadEventEnd&quot;:1636678991639}}]}	ux	select-subject-gender																							Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/95.0.4638.74 Safari/537.36						en-GB										1	24	980	1603				Australia/Sydney			412	869	UTF-8	980	2061												2021-11-12 01:03:13.795			{&quot;schema&quot;:&quot;iglu:com.snowplowanalytics.snowplow/contexts/jsonschema/1-0-1&quot;,&quot;data&quot;:[{&quot;schema&quot;:&quot;iglu:com.snowplowanalytics.snowplow/ua_parser_context/jsonschema/1-0-0&quot;,&quot;data&quot;:{&quot;useragentFamily&quot;:&quot;Chrome&quot;,&quot;useragentMajor&quot;:&quot;95&quot;,&quot;useragentMinor&quot;:&quot;0&quot;,&quot;useragentPatch&quot;:&quot;4638&quot;,&quot;useragentVersion&quot;:&quot;Chrome 95.0.4638&quot;,&quot;osFamily&quot;:&quot;Linux&quot;,&quot;osMajor&quot;:null,&quot;osMinor&quot;:null,&quot;osPatch&quot;:null,&quot;osPatchMinor&quot;:null,&quot;osVersion&quot;:&quot;Linux&quot;,&quot;deviceFamily&quot;:&quot;Other&quot;}},{&quot;schema&quot;:&quot;iglu:nl.basjes/yauaa_context/jsonschema/1-0-2&quot;,&quot;data&quot;:{&quot;deviceBrand&quot;:&quot;Unknown&quot;,&quot;deviceName&quot;:&quot;Linux Desktop&quot;,&quot;operatingSystemVersionMajor&quot;:&quot;Intel x86&quot;,&quot;layoutEngineNameVersion&quot;:&quot;Blink 95.0&quot;,&quot;operatingSystemNameVersion&quot;:&quot;Linux Intel x86_64&quot;,&quot;layoutEngineNameVersionMajor&quot;:&quot;Blink 95&quot;,&quot;operatingSystemName&quot;:&quot;Linux&quot;,&quot;agentVersionMajor&quot;:&quot;95&quot;,&quot;layoutEngineVersionMajor&quot;:&quot;95&quot;,&quot;deviceClass&quot;:&quot;Desktop&quot;,&quot;agentNameVersionMajor&quot;:&quot;Chrome 95&quot;,&quot;operatingSystemNameVersionMajor&quot;:&quot;Linux Intel x86&quot;,&quot;deviceCpuBits&quot;:&quot;64&quot;,&quot;operatingSystemClass&quot;:&quot;Desktop&quot;,&quot;layoutEngineName&quot;:&quot;Blink&quot;,&quot;agentName&quot;:&quot;Chrome&quot;,&quot;agentVersion&quot;:&quot;95.0.4638.74&quot;,&quot;layoutEngineClass&quot;:&quot;Browser&quot;,&quot;agentNameVersion&quot;:&quot;Chrome 95.0.4638.74&quot;,&quot;operatingSystemVersion&quot;:&quot;Intel x86_64&quot;,&quot;deviceCpu&quot;:&quot;Intel x86_64&quot;,&quot;agentClass&quot;:&quot;Browser&quot;,&quot;layoutEngineVersion&quot;:&quot;95.0&quot;}},{&quot;schema&quot;:&quot;iglu:org.ietf/http_header/jsonschema/1-0-0&quot;,&quot;data&quot;:{&quot;name&quot;:&quot;X-Forwarded-For&quot;,&quot;value&quot;:&quot;122.150.112.14&quot;}},{&quot;schema&quot;:&quot;iglu:org.ietf/http_header/jsonschema/1-0-0&quot;,&quot;data&quot;:{&quot;name&quot;:&quot;Host&quot;,&quot;value&quot;:&quot;sp.mymusclechef.com&quot;}},{&quot;schema&quot;:&quot;iglu:org.ietf/http_header/jsonschema/1-0-0&quot;,&quot;data&quot;:{&quot;name&quot;:&quot;User-Agent&quot;,&quot;value&quot;:&quot;Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/95.0.4638.74 Safari/537.36&quot;}},{&quot;schema&quot;:&quot;iglu:org.ietf/http_header/jsonschema/1-0-0&quot;,&quot;data&quot;:{&quot;name&quot;:&quot;Origin&quot;,&quot;value&quot;:&quot;https://www.mymusclechef.com&quot;}},{&quot;schema&quot;:&quot;iglu:org.ietf/http_header/jsonschema/1-0-0&quot;,&quot;data&quot;:{&quot;name&quot;:&quot;Referer&quot;,&quot;value&quot;:&quot;https://www.mymusclechef.com/&quot;}},{&quot;schema&quot;:&quot;iglu:com.dbip/location/jsonschema/1-0-0&quot;,&quot;data&quot;:{&quot;city&quot;:{&quot;geoname_id&quot;:2154855,&quot;names&quot;:{&quot;en&quot;:&quot;North Sydney&quot;,&quot;ja&quot;:&quot;ノースシドニー&quot;}},&quot;continent&quot;:{&quot;code&quot;:&quot;OC&quot;,&quot;geoname_id&quot;:6255151,&quot;names&quot;:{&quot;de&quot;:&quot;Ozeanien&quot;,&quot;en&quot;:&quot;Oceania&quot;,&quot;es&quot;:&quot;Oceanía&quot;,&quot;fa&quot;:&quot;اقیانوسیه&quot;,&quot;fr&quot;:&quot;Océanie&quot;,&quot;ja&quot;:&quot;オセアニア&quot;,&quot;ko&quot;:&quot;오세아니아&quot;,&quot;pt-BR&quot;:&quot;Oceania&quot;,&quot;ru&quot;:&quot;Океания&quot;,&quot;zh-CN&quot;:&quot;大洋洲&quot;}},&quot;country&quot;:{&quot;geoname_id&quot;:2077456,&quot;is_in_european_union&quot;:false,&quot;iso_code&quot;:&quot;AU&quot;,&quot;names&quot;:{&quot;de&quot;:&quot;Australien&quot;,&quot;en&quot;:&quot;Australia&quot;,&quot;es&quot;:&quot;Australia&quot;,&quot;fa&quot;:&quot;استرالیا&quot;,&quot;fr&quot;:&quot;Australie&quot;,&quot;ja&quot;:&quot;オーストラリア&quot;,&quot;ko&quot;:&quot;오스트레일리아&quot;,&quot;pt-BR&quot;:&quot;Austrália&quot;,&quot;ru&quot;:&quot;Австралия&quot;,&quot;zh-CN&quot;:&quot;澳大利亚&quot;}},&quot;location&quot;:{&quot;latitude&quot;:-33.8392,&quot;longitude&quot;:151.206,&quot;time_zone&quot;:&quot;Australia/Sydney&quot;,&quot;weather_code&quot;:&quot;ASXX0274&quot;},&quot;postal&quot;:{&quot;code&quot;:&quot;2055&quot;},&quot;subdivisions&quot;:[{&quot;geoname_id&quot;:2155400,&quot;iso_code&quot;:&quot;NSW&quot;,&quot;names&quot;:{&quot;en&quot;:&quot;New South Wales&quot;,&quot;fr&quot;:&quot;Nouvelle-Galles du Sud&quot;,&quot;pt-BR&quot;:&quot;Nova Gales do Sul&quot;,&quot;ru&quot;:&quot;Новый Южный Уэльс&quot;}},{&quot;geoname_id&quot;:7839759,&quot;names&quot;:{&quot;de&quot;:&quot;North Sydney Council&quot;,&quot;en&quot;:&quot;North Sydney Council&quot;,&quot;fr&quot;:&quot;Conseil de Sydney Nord&quot;,&quot;ja&quot;:&quot;ノース・シドニー・カウンシル&quot;,&quot;zh-CN&quot;:&quot;北雪梨議會&quot;}}]}},{&quot;schema&quot;:&quot;iglu:com.dbip/isp/jsonschema/1-0-0&quot;,&quot;data&quot;:{&quot;traits&quot;:{&quot;autonomous_system_number&quot;:9443,&quot;autonomous_system_organization&quot;:&quot;VOCUS PTY LTD&quot;,&quot;connection_type&quot;:&quot;Corporate&quot;,&quot;isp&quot;:&quot;Vocus PTY LTD&quot;,&quot;organization&quot;:&quot;VOCUS&quot;}}}]}	521235a6-dad6-4075-92fd-1c4112025e8b	2021-11-12 01:03:13.666	com.google.analytics	event	jsonschema	1-0-0	9f9f142c86e792929835d910ff3d22ed&#39;</span>
<span class="sd">&quot;&quot;&quot;Real-world line of raw data for testing purposes.&quot;&quot;&quot;</span>


<div class="viewcode-block" id="Neo"><a class="viewcode-back" href="../../entity_resolution.html#entity_resolution.data.Neo">[docs]</a><span class="k">class</span> <span class="nc">Neo</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Utility class to access Neo4j.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">uri</span> <span class="o">=</span> <span class="s2">&quot;bolt://localhost:7687&quot;</span><span class="p">,</span> <span class="n">user</span> <span class="o">=</span> <span class="s2">&quot;neo4j&quot;</span><span class="p">,</span> <span class="n">password</span> <span class="o">=</span> <span class="s2">&quot;123&quot;</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">imports</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_driver</span> <span class="o">=</span> <span class="n">GraphDatabase</span><span class="o">.</span><span class="n">driver</span><span class="p">(</span><span class="n">uri</span><span class="p">,</span> <span class="n">auth</span> <span class="o">=</span> <span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="n">password</span><span class="p">))</span>

<div class="viewcode-block" id="Neo.close"><a class="viewcode-back" href="../../entity_resolution.html#entity_resolution.data.Neo.close">[docs]</a>    <span class="k">def</span> <span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_driver</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>

<div class="viewcode-block" id="Neo.get_databases"><a class="viewcode-back" href="../../entity_resolution.html#entity_resolution.data.Neo.get_databases">[docs]</a>    <span class="k">def</span> <span class="nf">get_databases</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the list of database names.</span>

<span class="sd">        :return: a list of names</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">q</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Show databases&quot;</span>
        <span class="n">coll</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_driver</span><span class="o">.</span><span class="n">session</span><span class="p">()</span> <span class="k">as</span> <span class="n">graphDB_Session</span><span class="p">:</span>
            <span class="n">graphDB_Session</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">q</span><span class="p">)</span>
            <span class="n">rows</span> <span class="o">=</span> <span class="n">graphDB_Session</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">q</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">rows</span><span class="p">:</span>
                <span class="n">coll</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">coll</span></div>

<div class="viewcode-block" id="Neo.delete_database"><a class="viewcode-back" href="../../entity_resolution.html#entity_resolution.data.Neo.delete_database">[docs]</a>    <span class="k">def</span> <span class="nf">delete_database</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Drops the specified database.</span>

<span class="sd">        :param name: the name of the database to remove.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">dbs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_databases</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">dbs</span><span class="p">:</span>
            <span class="n">q</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;DROP DATABASE </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2"> IF EXISTS&quot;</span>
            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_driver</span><span class="o">.</span><span class="n">session</span><span class="p">()</span> <span class="k">as</span> <span class="n">graphDB_Session</span><span class="p">:</span>
                <span class="n">graphDB_Session</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">q</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Database &#39;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39; has been removed.&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Database &#39;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39; does not exist.&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="Neo.create_database"><a class="viewcode-back" href="../../entity_resolution.html#entity_resolution.data.Neo.create_database">[docs]</a>    <span class="k">def</span> <span class="nf">create_database</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">db_name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Creates the specified database.</span>

<span class="sd">        :param db_name: the name of the new database</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">db_name</span> <span class="o">=</span> <span class="nb">str</span><span class="o">.</span><span class="n">lower</span><span class="p">(</span><span class="n">db_name</span><span class="p">)</span>
        <span class="n">dbs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_databases</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">db_name</span> <span class="ow">in</span> <span class="n">dbs</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Database&#39;</span><span class="si">{</span><span class="n">db_name</span><span class="si">}</span><span class="s2">&#39; already exists.&quot;</span><span class="p">)</span>

        <span class="n">q</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;create database </span><span class="si">{</span><span class="n">db_name</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_driver</span><span class="o">.</span><span class="n">session</span><span class="p">()</span> <span class="k">as</span> <span class="n">graphDB_Session</span><span class="p">:</span>
            <span class="n">graphDB_Session</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">q</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Database &#39;</span><span class="si">{</span><span class="n">db_name</span><span class="si">}</span><span class="s2">&#39; has been created.&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="Neo.truncate_db"><a class="viewcode-back" href="../../entity_resolution.html#entity_resolution.data.Neo.truncate_db">[docs]</a>    <span class="k">def</span> <span class="nf">truncate_db</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">db_name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Truncates the specified database.</span>

<span class="sd">        :param db_name: the name of the database.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">db_name</span> <span class="o">=</span> <span class="nb">str</span><span class="o">.</span><span class="n">lower</span><span class="p">(</span><span class="n">db_name</span><span class="p">)</span>
        <span class="n">dbs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_databases</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">db_name</span> <span class="ow">in</span> <span class="n">dbs</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Database&#39;</span><span class="si">{</span><span class="n">db_name</span><span class="si">}</span><span class="s2">&#39; does not exists.&quot;</span><span class="p">)</span>

        <span class="n">q</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Match (x) detach delete x&quot;</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_driver</span><span class="o">.</span><span class="n">session</span><span class="p">(</span><span class="n">database</span> <span class="o">=</span> <span class="n">db_name</span><span class="p">)</span> <span class="k">as</span> <span class="n">graphDB_Session</span><span class="p">:</span>
            <span class="n">graphDB_Session</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">q</span><span class="p">)</span></div>

<div class="viewcode-block" id="Neo.write_graph"><a class="viewcode-back" href="../../entity_resolution.html#entity_resolution.data.Neo.write_graph">[docs]</a>    <span class="k">def</span> <span class="nf">write_graph</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">db_name</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">clear_content</span> <span class="o">=</span> <span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Transfers the given graph to Neo4j.</span>

<span class="sd">        :param db_name: the name of the database, if not present it will be created</span>
<span class="sd">        :param g: the graph</span>
<span class="sd">        :param clear_content: whether to clear the database before inserting the new graph</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">db_name</span> <span class="o">=</span> <span class="nb">str</span><span class="o">.</span><span class="n">lower</span><span class="p">(</span><span class="n">db_name</span><span class="p">)</span>
        <span class="n">dbs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_databases</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">db_name</span> <span class="ow">in</span> <span class="n">dbs</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">create_database</span><span class="p">(</span><span class="n">db_name</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">clear_content</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">truncate_db</span><span class="p">(</span><span class="n">db_name</span><span class="p">)</span>

        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_driver</span><span class="o">.</span><span class="n">session</span><span class="p">(</span><span class="n">database</span> <span class="o">=</span> <span class="n">db_name</span><span class="p">)</span> <span class="k">as</span> <span class="n">graphDB_Session</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Creating nodes&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">nodes</span><span class="p">()):</span>
                <span class="nb">id</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">nodes</span><span class="p">()[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;id&quot;</span><span class="p">]</span>
                <span class="n">label</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">nodes</span><span class="p">()[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;label&quot;</span><span class="p">]</span>
                <span class="n">q</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Create (n:</span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="se">{{</span><span class="s2">id: $id</span><span class="se">}}</span><span class="s2">)&quot;</span>
                <span class="n">graphDB_Session</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="nb">id</span><span class="p">})</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Creating edges&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">u</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">edges</span><span class="p">()):</span>
                <span class="n">s_id</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">nodes</span><span class="p">()[</span><span class="n">u</span><span class="p">][</span><span class="s2">&quot;id&quot;</span><span class="p">]</span>
                <span class="n">t_id</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">nodes</span><span class="p">()[</span><span class="n">v</span><span class="p">][</span><span class="s2">&quot;id&quot;</span><span class="p">]</span>

                <span class="n">s_label</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">nodes</span><span class="p">()[</span><span class="n">u</span><span class="p">][</span><span class="s2">&quot;label&quot;</span><span class="p">]</span>
                <span class="n">t_label</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">nodes</span><span class="p">()[</span><span class="n">v</span><span class="p">][</span><span class="s2">&quot;label&quot;</span><span class="p">]</span>

                <span class="n">edge_label</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">edges</span><span class="p">()[(</span><span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">)][</span><span class="s2">&quot;label&quot;</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">edge_label</span> <span class="o">==</span> <span class="s2">&quot;INFERRED&quot;</span><span class="p">:</span>
                    <span class="n">p</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">edges</span><span class="p">()[(</span><span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">)][</span><span class="s2">&quot;p&quot;</span><span class="p">]</span>
                    <span class="n">q</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">                                Match (u:</span><span class="si">{</span><span class="n">s_label</span><span class="si">}</span><span class="se">{{</span><span class="s2">id: $s</span><span class="se">}}</span><span class="s2">)</span>
<span class="s2">                                Match (v:</span><span class="si">{</span><span class="n">t_label</span><span class="si">}</span><span class="se">{{</span><span class="s2">id: $t</span><span class="se">}}</span><span class="s2">)</span>
<span class="s2">                                Merge (u)-[:INFERRED</span><span class="se">{{</span><span class="s2">p: $p</span><span class="se">}}</span><span class="s2">]-&gt;(v)</span>
<span class="s2">                                &quot;&quot;&quot;</span>
                    <span class="n">graphDB_Session</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;s&quot;</span><span class="p">:</span> <span class="n">s_id</span><span class="p">,</span> <span class="s2">&quot;t&quot;</span><span class="p">:</span> <span class="n">t_id</span><span class="p">,</span> <span class="s2">&quot;p&quot;</span><span class="p">:</span> <span class="n">p</span><span class="p">})</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">q</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">                                Match (u:</span><span class="si">{</span><span class="n">s_label</span><span class="si">}</span><span class="se">{{</span><span class="s2">id: $s</span><span class="se">}}</span><span class="s2">)</span>
<span class="s2">                                Match (v:</span><span class="si">{</span><span class="n">t_label</span><span class="si">}</span><span class="se">{{</span><span class="s2">id: $t</span><span class="se">}}</span><span class="s2">)</span>
<span class="s2">                                Merge (u)-[:</span><span class="si">{</span><span class="n">edge_label</span><span class="si">}</span><span class="s2">]-&gt;(v)</span>
<span class="s2">                                &quot;&quot;&quot;</span>
                    <span class="n">graphDB_Session</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;s&quot;</span><span class="p">:</span> <span class="n">s_id</span><span class="p">,</span> <span class="s2">&quot;t&quot;</span><span class="p">:</span> <span class="n">t_id</span><span class="p">})</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Done.&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="Neo.get_graph"><a class="viewcode-back" href="../../entity_resolution.html#entity_resolution.data.Neo.get_graph">[docs]</a>    <span class="k">def</span> <span class="nf">get_graph</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">db_name</span><span class="p">,</span> <span class="n">max_nodes</span> <span class="o">=</span> <span class="mi">5000</span><span class="p">,</span> <span class="n">max_edges</span> <span class="o">=</span> <span class="mi">5000</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Fetches the graph in the specified database.</span>

<span class="sd">        :param db_name: the database name</span>
<span class="sd">        :param max_nodes: the maximum amount of node to fetch, default 5000</span>
<span class="sd">        :param max_edges: the maximum amount of edges to fetch, default 5000</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">g</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">DiGraph</span><span class="p">()</span>
        <span class="n">g</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">db_name</span>

        <span class="n">id_dic</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">def</span> <span class="nf">id_exists</span><span class="p">(</span><span class="nb">id</span><span class="p">):</span>
            <span class="k">return</span> <span class="nb">id</span> <span class="ow">in</span> <span class="n">id_dic</span>

        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_driver</span><span class="o">.</span><span class="n">session</span><span class="p">(</span><span class="n">database</span> <span class="o">=</span> <span class="n">db_name</span><span class="p">)</span> <span class="k">as</span> <span class="n">graphDB_Session</span><span class="p">:</span>
            <span class="c1"># nodes</span>
            <span class="n">q</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Match (u) return distinct u.id as id, labels(u)[0] as label limit </span><span class="si">{</span><span class="n">max_nodes</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="n">rows</span> <span class="o">=</span> <span class="n">graphDB_Session</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">q</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">rows</span><span class="p">:</span>
                <span class="n">u_id</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]</span>
                <span class="n">u_label</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;label&quot;</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">u_id</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">u_label</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">id_exists</span><span class="p">(</span><span class="n">u_id</span><span class="p">):</span>
                    <span class="n">i</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">nodes</span><span class="p">())</span>
                    <span class="n">g</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="n">u_label</span><span class="p">,</span> <span class="nb">id</span> <span class="o">=</span> <span class="n">u_id</span><span class="p">)</span>
                    <span class="n">id_dic</span><span class="p">[</span><span class="n">u_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span>

            <span class="n">q</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Match (u)-[r]-&gt;(v) return u.id as uid, labels(u)[0] as ulabel, type(r) as elabel, v.id as vid, labels(v)[0] as vlabel limit </span><span class="si">{</span><span class="n">max_edges</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="n">rows</span> <span class="o">=</span> <span class="n">graphDB_Session</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">q</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">rows</span><span class="p">:</span>
                <span class="n">u_id</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;uid&quot;</span><span class="p">]</span>
                <span class="n">u_label</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;ulabel&quot;</span><span class="p">]</span>
                <span class="n">v_id</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;vid&quot;</span><span class="p">]</span>
                <span class="n">v_label</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;vlabel&quot;</span><span class="p">]</span>
                <span class="n">e_label</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;elabel&quot;</span><span class="p">]</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">id_exists</span><span class="p">(</span><span class="n">u_id</span><span class="p">):</span>
                    <span class="k">continue</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">i</span> <span class="o">=</span> <span class="n">id_dic</span><span class="p">[</span><span class="n">u_id</span><span class="p">]</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">id_exists</span><span class="p">(</span><span class="n">v_id</span><span class="p">):</span>
                    <span class="k">continue</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">j</span> <span class="o">=</span> <span class="n">id_dic</span><span class="p">[</span><span class="n">v_id</span><span class="p">]</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">e_label</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">g</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="n">e_label</span><span class="p">)</span>
        <span class="n">components</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">nx</span><span class="o">.</span><span class="n">connected_components</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">to_undirected</span><span class="p">()))</span>
        <span class="n">largest</span> <span class="o">=</span> <span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">components</span><span class="p">,</span> <span class="n">key</span> <span class="o">=</span> <span class="nb">len</span><span class="p">,</span> <span class="n">reverse</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)][</span><span class="mi">0</span><span class="p">]</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Nodes:&quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">nodes</span><span class="p">()),</span> <span class="s2">&quot;Edges:&quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">edges</span><span class="p">()),</span> <span class="s2">&quot;Components:&quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">components</span><span class="p">),</span> <span class="s2">&quot;Largest component:&quot;</span><span class="p">,</span> <span class="n">largest</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">g</span></div>

<div class="viewcode-block" id="Neo.write_predictions"><a class="viewcode-back" href="../../entity_resolution.html#entity_resolution.data.Neo.write_predictions">[docs]</a>    <span class="k">def</span> <span class="nf">write_predictions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">db_name</span><span class="p">,</span> <span class="n">predictions</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Write the inferred identities as INFERRED-edges to the database.</span>

<span class="sd">        :param db_name: the name of the datbase</span>
<span class="sd">        :param predictions: the prediction tuples to export</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_driver</span><span class="o">.</span><span class="n">session</span><span class="p">(</span><span class="n">database</span> <span class="o">=</span> <span class="n">db_name</span><span class="p">)</span> <span class="k">as</span> <span class="n">graphDB_Session</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">s</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">predictions</span><span class="p">:</span>
                <span class="n">q</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">                Match (u:Device{id: $u})</span>
<span class="s2">                Match (v:Identity{id: $v})</span>
<span class="s2">                Merge (u)-[:INFERRED{p: $p}]-&gt;(v)</span>
<span class="s2">                &quot;&quot;&quot;</span>
                <span class="n">graphDB_Session</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;u&quot;</span><span class="p">:</span> <span class="n">s</span><span class="p">,</span> <span class="s2">&quot;v&quot;</span><span class="p">:</span> <span class="n">t</span><span class="p">,</span> <span class="s2">&quot;p&quot;</span><span class="p">:</span> <span class="n">p</span><span class="p">})</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Written </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">predictions</span><span class="p">)</span><span class="si">}</span><span class="s2"> prediction(s) to the &#39;</span><span class="si">{</span><span class="n">db_name</span><span class="si">}</span><span class="s2">&#39; database.&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="Neo.remove_inferred_edges"><a class="viewcode-back" href="../../entity_resolution.html#entity_resolution.data.Neo.remove_inferred_edges">[docs]</a>    <span class="k">def</span> <span class="nf">remove_inferred_edges</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">db_name</span><span class="p">):</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_driver</span><span class="o">.</span><span class="n">session</span><span class="p">(</span><span class="n">database</span> <span class="o">=</span> <span class="n">db_name</span><span class="p">)</span> <span class="k">as</span> <span class="n">graphDB_Session</span><span class="p">:</span>
            <span class="n">q</span> <span class="o">=</span> <span class="s2">&quot;Match ()-[r:INFERRED]-&gt;() delete r&quot;</span>
            <span class="n">graphDB_Session</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">q</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;All INFERRED edges have been removed from database &#39;</span><span class="si">{</span><span class="n">db_name</span><span class="si">}</span><span class="s2">&#39;.&quot;</span><span class="p">)</span></div></div>


<span class="k">def</span> <span class="nf">__add_node</span><span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="n">label</span><span class="p">,</span> <span class="nb">id</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Adds a node with the given label and id.</span>

<span class="sd">    :param g: the graph</span>
<span class="sd">    :param label: the label</span>
<span class="sd">    :param id: the unique id</span>
<span class="sd">    :return: the node index</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">i</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">nodes</span><span class="p">())</span>
    <span class="n">g</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="n">label</span><span class="p">,</span> <span class="nb">id</span> <span class="o">=</span> <span class="nb">id</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">i</span>


<span class="k">def</span> <span class="nf">__add_nodes</span><span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="n">label</span><span class="p">,</span> <span class="n">count</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Adds a bunch of nodes with the specified label.</span>

<span class="sd">    :param g: the graph</span>
<span class="sd">    :param label: the label</span>
<span class="sd">    :param count: how many nodes to add</span>
<span class="sd">    :return: a mapping from node index to node id</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">dic</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">count</span><span class="p">):</span>
        <span class="nb">id</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">())</span>
        <span class="n">i</span> <span class="o">=</span> <span class="n">__add_node</span><span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="n">label</span><span class="p">,</span> <span class="nb">id</span><span class="p">)</span>
        <span class="n">dic</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">id</span>
    <span class="k">return</span> <span class="n">dic</span>


<span class="k">def</span> <span class="nf">__connect</span><span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">label</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Connects the given indices</span>

<span class="sd">    :param g: the graph</span>
<span class="sd">    :param i: the source index</span>
<span class="sd">    :param j: the target index</span>
<span class="sd">    :param label: the label on the edge</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">g</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="n">label</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">__add_cookies</span><span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="n">device_dic</span><span class="p">,</span> <span class="n">p</span> <span class="o">=</span> <span class="mf">0.3</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    All devices have a cookie with the same id by default.</span>
<span class="sd">    In addition there is a p chance that another one is shared</span>
<span class="sd">    and a (1-p) chance that a dangling one is added.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">dic</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">device_dic</span><span class="p">:</span>
        <span class="nb">id</span> <span class="o">=</span> <span class="n">device_dic</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="c1"># always add the default cookie</span>
        <span class="n">j</span> <span class="o">=</span> <span class="n">__add_node</span><span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="s2">&quot;Cookie&quot;</span><span class="p">,</span> <span class="nb">id</span><span class="p">)</span>
        <span class="n">dic</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="nb">id</span>
        <span class="n">__connect</span><span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="s2">&quot;HAS_COOKIE&quot;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">device_dic</span><span class="p">:</span>
        <span class="c1">#  chance to random __connect to another</span>
        <span class="k">if</span> <span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">()</span> <span class="o">&lt;</span> <span class="n">p</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">dic</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">j</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">([</span><span class="n">u</span> <span class="k">for</span> <span class="n">u</span> <span class="ow">in</span> <span class="n">dic</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">if</span> <span class="n">u</span> <span class="o">!=</span> <span class="n">i</span><span class="p">])</span>
            <span class="k">assert</span> <span class="n">i</span> <span class="o">!=</span> <span class="n">j</span><span class="p">,</span> <span class="s2">&quot;&gt;&gt;&gt;&quot;</span>
            <span class="n">__connect</span><span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="s2">&quot;HAS_COOKIE&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">id</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">())</span>
            <span class="n">j</span> <span class="o">=</span> <span class="n">__add_node</span><span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="s2">&quot;Cookie&quot;</span><span class="p">,</span> <span class="nb">id</span><span class="p">)</span>
            <span class="n">dic</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span>
            <span class="n">__connect</span><span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="s2">&quot;HAS_COOKIE&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">dic</span>


<span class="k">def</span> <span class="nf">__add_other</span><span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="n">device_dic</span><span class="p">,</span> <span class="n">label</span><span class="p">,</span> <span class="n">p</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Add the location or ip nodes.</span>

<span class="sd">    :param g:</span>
<span class="sd">    :param device_dic:</span>
<span class="sd">    :param label:</span>
<span class="sd">    :param p:</span>
<span class="sd">    :return:</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">upper_label</span> <span class="o">=</span> <span class="nb">str</span><span class="o">.</span><span class="n">upper</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>
    <span class="n">capital_label</span> <span class="o">=</span> <span class="nb">str</span><span class="o">.</span><span class="n">capitalize</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">upper_label</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;IP&quot;</span><span class="p">,</span> <span class="s2">&quot;LOCATION&quot;</span><span class="p">]:</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Unexpected label &#39;</span><span class="si">{label}</span><span class="s2">&#39;. Only IP or Location is supported.&quot;</span><span class="p">)</span>
    <span class="n">dic</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">def</span> <span class="nf">has_other</span><span class="p">(</span><span class="n">w</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">([</span><span class="n">v</span> <span class="k">for</span> <span class="n">u</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">g</span><span class="o">.</span><span class="n">out_edges</span><span class="p">(</span><span class="n">w</span><span class="p">)</span> <span class="k">if</span> <span class="n">g</span><span class="o">.</span><span class="n">nodes</span><span class="p">()[</span><span class="n">v</span><span class="p">][</span><span class="s2">&quot;label&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">label</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span>

    <span class="k">def</span> <span class="nf">get_other</span><span class="p">(</span><span class="n">w</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">v</span> <span class="k">for</span> <span class="n">u</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">g</span><span class="o">.</span><span class="n">out_edges</span><span class="p">(</span><span class="n">w</span><span class="p">)</span> <span class="k">if</span> <span class="n">g</span><span class="o">.</span><span class="n">nodes</span><span class="p">()[</span><span class="n">v</span><span class="p">][</span><span class="s2">&quot;label&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">label</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">get_parent_devices</span><span class="p">(</span><span class="n">w</span><span class="p">):</span>
        <span class="n">device_is</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">predecessors</span><span class="p">(</span><span class="n">w</span><span class="p">))</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">device_is</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">2</span>

        <span class="n">u</span><span class="p">,</span> <span class="n">v</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">device_is</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">replace</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">u</span> <span class="o">!=</span> <span class="n">v</span>
        <span class="k">return</span> <span class="n">u</span><span class="p">,</span> <span class="n">v</span>

    <span class="n">shared_cookies</span> <span class="o">=</span> <span class="p">[</span><span class="n">u</span> <span class="k">for</span> <span class="n">u</span> <span class="ow">in</span> <span class="n">g</span><span class="o">.</span><span class="n">nodes</span><span class="p">()</span> <span class="k">if</span> <span class="n">g</span><span class="o">.</span><span class="n">nodes</span><span class="p">()[</span><span class="n">u</span><span class="p">][</span><span class="s2">&quot;label&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;Cookie&quot;</span> <span class="ow">and</span> <span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">degree</span><span class="p">(</span><span class="n">u</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">)]</span>

    <span class="k">for</span> <span class="n">cookie_i</span> <span class="ow">in</span> <span class="n">shared_cookies</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">()</span> <span class="o">&lt;</span> <span class="n">p</span><span class="p">:</span>

            <span class="n">u</span><span class="p">,</span> <span class="n">v</span> <span class="o">=</span> <span class="n">get_parent_devices</span><span class="p">(</span><span class="n">cookie_i</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">has_other</span><span class="p">(</span><span class="n">u</span><span class="p">)</span> <span class="ow">or</span> <span class="n">has_other</span><span class="p">(</span><span class="n">v</span><span class="p">):</span>
                <span class="k">continue</span>
            <span class="k">assert</span> <span class="ow">not</span> <span class="n">u</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">g</span><span class="o">.</span><span class="n">has_node</span><span class="p">(</span><span class="n">u</span><span class="p">)</span>
            <span class="k">assert</span> <span class="ow">not</span> <span class="n">v</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">g</span><span class="o">.</span><span class="n">has_node</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
            <span class="nb">id</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">())</span>
            <span class="n">other_i</span> <span class="o">=</span> <span class="n">__add_node</span><span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="n">capital_label</span><span class="p">,</span> <span class="nb">id</span><span class="p">)</span>
            <span class="n">dic</span><span class="p">[</span><span class="n">other_i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">id</span>

            <span class="n">__connect</span><span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">other_i</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;HAS_</span><span class="si">{</span><span class="n">upper_label</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">__connect</span><span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">other_i</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;HAS_</span><span class="si">{</span><span class="n">upper_label</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">assert</span> <span class="n">g</span><span class="o">.</span><span class="n">degree</span><span class="p">(</span><span class="n">other_i</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span>
    <span class="c1"># the one remaining</span>
    <span class="k">for</span> <span class="n">device_i</span> <span class="ow">in</span> <span class="n">device_dic</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">has_other</span><span class="p">(</span><span class="n">device_i</span><span class="p">):</span>
            <span class="k">continue</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">id</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">())</span>
            <span class="n">other_i</span> <span class="o">=</span> <span class="n">__add_node</span><span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="n">capital_label</span><span class="p">,</span> <span class="nb">id</span><span class="p">)</span>
            <span class="n">dic</span><span class="p">[</span><span class="n">other_i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">id</span>
            <span class="n">__connect</span><span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="n">device_i</span><span class="p">,</span> <span class="n">other_i</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;HAS_</span><span class="si">{</span><span class="n">upper_label</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">dic</span>


<div class="viewcode-block" id="create_synthetic_graph"><a class="viewcode-back" href="../../entity_resolution.html#entity_resolution.data.create_synthetic_graph">[docs]</a><span class="k">def</span> <span class="nf">create_synthetic_graph</span><span class="p">(</span><span class="n">device_count</span> <span class="o">=</span> <span class="mi">150</span><span class="p">,</span> <span class="n">identity_count</span> <span class="o">=</span> <span class="mi">50</span><span class="p">,</span> <span class="n">cookie_probability</span> <span class="o">=</span> <span class="mf">0.3</span><span class="p">,</span> <span class="n">ip_probability</span> <span class="o">=</span> <span class="mf">0.3</span><span class="p">,</span> <span class="n">location_probability</span> <span class="o">=</span> <span class="mf">0.3</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">object</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns a graph with the same topological features as real-world dataset.</span>

<span class="sd">    :param device_count: how many devices to create</span>
<span class="sd">    :param identity_count: how many identities to create</span>
<span class="sd">    :param cookie_probability: the probability that a cookie is shared</span>
<span class="sd">    :param ip_probability: the probability that an IP node is shared</span>
<span class="sd">    :param location_probability: the probability that a Location node is shared</span>
<span class="sd">    :return: a graph</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">identity_count</span> <span class="o">&gt;</span> <span class="n">device_count</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;The device count should be larger than the identity count.&quot;</span><span class="p">)</span>
    <span class="n">g</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">DiGraph</span><span class="p">()</span>
    <span class="n">device_dic</span> <span class="o">=</span> <span class="n">__add_nodes</span><span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="s2">&quot;Device&quot;</span><span class="p">,</span> <span class="n">device_count</span><span class="p">)</span>
    <span class="n">identity_dic</span> <span class="o">=</span> <span class="n">__add_nodes</span><span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="s2">&quot;Identity&quot;</span><span class="p">,</span> <span class="n">identity_count</span><span class="p">)</span>
    <span class="c1"># assigning the identities to the devices</span>
    <span class="n">target_ids</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">identity_dic</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
    <span class="n">source_ids</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span>
        <span class="nb">list</span><span class="p">(</span><span class="n">device_dic</span><span class="o">.</span><span class="n">keys</span><span class="p">()),</span> <span class="n">identity_count</span><span class="p">,</span> <span class="n">replace</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">source_ids</span><span class="p">,</span> <span class="n">target_ids</span><span class="p">):</span>
        <span class="n">__connect</span><span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="o">*</span><span class="n">t</span><span class="p">,</span> <span class="s2">&quot;HAS_IDENTITY&quot;</span><span class="p">)</span>

    <span class="n">cookie_dic</span> <span class="o">=</span> <span class="n">__add_cookies</span><span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="n">device_dic</span><span class="p">,</span> <span class="n">cookie_probability</span><span class="p">)</span>

    <span class="n">ip_dic</span> <span class="o">=</span> <span class="n">__add_other</span><span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="n">device_dic</span><span class="p">,</span> <span class="s2">&quot;IP&quot;</span><span class="p">,</span> <span class="n">ip_probability</span><span class="p">)</span>
    <span class="n">location_dic</span> <span class="o">=</span> <span class="n">__add_other</span><span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="n">device_dic</span><span class="p">,</span> <span class="s2">&quot;Location&quot;</span><span class="p">,</span> <span class="n">location_probability</span><span class="p">)</span>

    <span class="c1"># the info can be used to print out stats</span>
    <span class="n">g</span><span class="o">.</span><span class="n">info</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Nodes: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">nodes</span><span class="p">())</span><span class="si">}</span><span class="s2">, Edges: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">edges</span><span class="p">())</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="k">return</span> <span class="n">g</span></div>


<div class="viewcode-block" id="create_synthetic_graphml_graph"><a class="viewcode-back" href="../../entity_resolution.html#entity_resolution.data.create_synthetic_graphml_graph">[docs]</a><span class="k">def</span> <span class="nf">create_synthetic_graphml_graph</span><span class="p">(</span><span class="n">add_inference</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">device_count</span> <span class="o">=</span> <span class="mi">150</span><span class="p">,</span> <span class="n">identity_count</span> <span class="o">=</span> <span class="mi">50</span><span class="p">,</span> <span class="n">cookie_probability</span> <span class="o">=</span> <span class="mf">0.3</span><span class="p">,</span> <span class="n">ip_probability</span> <span class="o">=</span> <span class="mf">0.3</span><span class="p">,</span> <span class="n">location_probability</span> <span class="o">=</span> <span class="mf">0.3</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Creates a graph with the same topological features as real-world dataset</span>
<span class="sd">        and opens the default GraphML application to present it.</span>

<span class="sd">        :param add_inference: whether to run the inference and add the edges to the output</span>
<span class="sd">        :param device_count: how many devices to create</span>
<span class="sd">        :param identity_count: how many identities to create</span>
<span class="sd">        :param cookie_probability: the probability that a cookie is shared</span>
<span class="sd">        :param ip_probability: the probability that an IP node is shared</span>
<span class="sd">        :param location_probability: the probability that a Location node is shared</span>
<span class="sd">        :return: a graph</span>
<span class="sd">        &quot;&quot;&quot;</span>
    <span class="n">g</span> <span class="o">=</span> <span class="n">create_synthetic_graph</span><span class="p">(</span><span class="n">device_count</span><span class="p">,</span> <span class="n">identity_count</span><span class="p">,</span> <span class="n">cookie_probability</span><span class="p">,</span> <span class="n">ip_probability</span><span class="p">,</span> <span class="n">location_probability</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">add_inference</span><span class="p">:</span>
        <span class="kn">from</span> <span class="nn">.inference</span> <span class="kn">import</span> <span class="n">infer_identities</span>
        <span class="n">inf</span> <span class="o">=</span> <span class="n">infer_identities</span><span class="p">(</span><span class="n">g</span><span class="p">)</span>
        <span class="n">g</span><span class="o">.</span><span class="n">add_edges_from</span><span class="p">([(</span><span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;p&quot;</span><span class="p">:</span> <span class="n">p</span><span class="p">})</span> <span class="k">for</span> <span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">inf</span><span class="p">],</span> <span class="n">label</span> <span class="o">=</span> <span class="s2">&quot;INFERRED&quot;</span><span class="p">)</span>
    <span class="n">graphml_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">(),</span> <span class="s2">&quot;synthetic.graphml&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;GraphML diagram at &quot;</span><span class="p">,</span> <span class="n">graphml_path</span><span class="p">)</span>
    <span class="n">nx</span><span class="o">.</span><span class="n">write_graphml</span><span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="n">graphml_path</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;open </span><span class="si">{</span><span class="n">graphml_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">g</span></div>


<div class="viewcode-block" id="create_synthetic_gephi_graph"><a class="viewcode-back" href="../../entity_resolution.html#entity_resolution.data.create_synthetic_gephi_graph">[docs]</a><span class="k">def</span> <span class="nf">create_synthetic_gephi_graph</span><span class="p">(</span><span class="n">device_count</span> <span class="o">=</span> <span class="mi">150</span><span class="p">,</span> <span class="n">identity_count</span> <span class="o">=</span> <span class="mi">50</span><span class="p">,</span> <span class="n">cookie_probability</span> <span class="o">=</span> <span class="mf">0.3</span><span class="p">,</span> <span class="n">ip_probability</span> <span class="o">=</span> <span class="mf">0.3</span><span class="p">,</span> <span class="n">location_probability</span> <span class="o">=</span> <span class="mf">0.3</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Creates a graph with the same topological features as real-world dataset</span>
<span class="sd">            and opens the Gephi application to present it.</span>

<span class="sd">            :param device_count: how many devices to create</span>
<span class="sd">            :param identity_count: how many identities to create</span>
<span class="sd">            :param cookie_probability: the probability that a cookie is shared</span>
<span class="sd">            :param ip_probability: the probability that an IP node is shared</span>
<span class="sd">            :param location_probability: the probability that a Location node is shared</span>
<span class="sd">            :return: a graph</span>
<span class="sd">            &quot;&quot;&quot;</span>
    <span class="n">g</span> <span class="o">=</span> <span class="n">create_synthetic_graph</span><span class="p">(</span><span class="n">device_count</span><span class="p">,</span> <span class="n">identity_count</span><span class="p">,</span> <span class="n">cookie_probability</span><span class="p">,</span> <span class="n">ip_probability</span><span class="p">,</span> <span class="n">location_probability</span><span class="p">)</span>
    <span class="n">gephi_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">(),</span> <span class="s2">&quot;synthetic.gexf&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;GraphML diagram at &quot;</span><span class="p">,</span> <span class="n">gephi_path</span><span class="p">)</span>
    <span class="n">nx</span><span class="o">.</span><span class="n">write_gexf</span><span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="n">gephi_path</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;open </span><span class="si">{</span><span class="n">gephi_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">g</span></div>


<span class="k">def</span> <span class="nf">__transform_template_to_graph</span><span class="p">(</span><span class="n">j</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Transforms the simple format to a graph.</span>

<span class="sd">    :param j:</span>
<span class="sd">    :return:</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">g</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">DiGraph</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">j</span><span class="p">[</span><span class="s2">&quot;nodes&quot;</span><span class="p">]:</span>
        <span class="n">g</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="n">a</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">label</span> <span class="o">=</span> <span class="n">a</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="nb">id</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">()))</span>
    <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">j</span><span class="p">[</span><span class="s2">&quot;edges&quot;</span><span class="p">]:</span>
        <span class="n">g</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="n">e</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">e</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">label</span> <span class="o">=</span> <span class="n">e</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">g</span>


<span class="k">def</span> <span class="nf">__transform_template_to_entities</span><span class="p">(</span><span class="n">j</span><span class="p">):</span>
    <span class="n">g</span> <span class="o">=</span> <span class="n">__transform_template_to_graph</span><span class="p">(</span><span class="n">j</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">graph_to_entities_json</span><span class="p">(</span><span class="n">g</span><span class="p">)</span>


<div class="viewcode-block" id="get_sample_graph"><a class="viewcode-back" href="../../entity_resolution.html#entity_resolution.data.get_sample_graph">[docs]</a><span class="k">def</span> <span class="nf">get_sample_graph</span><span class="p">(</span><span class="n">name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;Basic&quot;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns a representative test-graph.</span>

<span class="sd">    :param name: the name of the test-case</span>
<span class="sd">    :return: a graph</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;No sample name specified.&quot;</span><span class="p">)</span>
    <span class="n">name</span> <span class="o">=</span> <span class="nb">str</span><span class="o">.</span><span class="n">lower</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">name</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;basic&quot;</span><span class="p">:</span>
        <span class="n">g</span> <span class="o">=</span> <span class="n">__transform_template_to_graph</span><span class="p">(</span><span class="n">__basic1</span><span class="p">)</span>
        <span class="n">g</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;Basic&quot;</span>
        <span class="k">return</span> <span class="n">g</span></div>


<div class="viewcode-block" id="get_sample_entities"><a class="viewcode-back" href="../../entity_resolution.html#entity_resolution.data.get_sample_entities">[docs]</a><span class="k">def</span> <span class="nf">get_sample_entities</span><span class="p">(</span><span class="n">name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;Basic&quot;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns a sample of entities for testing purposes.</span>

<span class="sd">    :param name:</span>
<span class="sd">    :return:</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;No sample name specified.&quot;</span><span class="p">)</span>
    <span class="n">name</span> <span class="o">=</span> <span class="nb">str</span><span class="o">.</span><span class="n">lower</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">name</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;basic&quot;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">__transform_template_to_entities</span><span class="p">(</span><span class="n">__basic1</span><span class="p">)</span></div>


<div class="viewcode-block" id="get_sample_entity"><a class="viewcode-back" href="../../entity_resolution.html#entity_resolution.data.get_sample_entity">[docs]</a><span class="k">def</span> <span class="nf">get_sample_entity</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">object</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns a typical set of transformed json.</span>

<span class="sd">    :return:</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">line</span> <span class="o">=</span> <span class="n">create_random_raw_line</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">transform_raw_line_to_entity</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></div>
    <span class="c1"># return {k: v for k, v in zip(__transform_keys, __sample_transformed)}</span>


<div class="viewcode-block" id="get_sample_raw_line"><a class="viewcode-back" href="../../entity_resolution.html#entity_resolution.data.get_sample_raw_line">[docs]</a><span class="k">def</span> <span class="nf">get_sample_raw_line</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns a typical line from the raw data.</span>

<span class="sd">    :return: a string/line</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">__sample_raw</span></div>


<div class="viewcode-block" id="get_raw_keys"><a class="viewcode-back" href="../../entity_resolution.html#entity_resolution.data.get_raw_keys">[docs]</a><span class="k">def</span> <span class="nf">get_raw_keys</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns the field names of the raw data.</span>

<span class="sd">    :return:</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">__raw_keys</span></div>


<div class="viewcode-block" id="create_random_raw_line"><a class="viewcode-back" href="../../entity_resolution.html#entity_resolution.data.create_random_raw_line">[docs]</a><span class="k">def</span> <span class="nf">create_random_raw_line</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Creates a representative TSV line.</span>

<span class="sd">    :return:</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">device</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">())</span>
    <span class="n">ip</span> <span class="o">=</span> <span class="n">fake</span><span class="o">.</span><span class="n">ipv4</span><span class="p">()</span>
    <span class="n">location</span> <span class="o">=</span> <span class="n">fake</span><span class="o">.</span><span class="n">city</span><span class="p">()</span>
    <span class="n">identity</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">())</span>
    <span class="n">cookie</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">())</span>
    <span class="k">return</span> <span class="n">create_raw_line</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="n">ip</span><span class="p">,</span> <span class="n">location</span><span class="p">,</span> <span class="n">identity</span><span class="p">,</span> <span class="n">cookie</span><span class="p">)</span></div>


<div class="viewcode-block" id="create_raw_line"><a class="viewcode-back" href="../../entity_resolution.html#entity_resolution.data.create_raw_line">[docs]</a><span class="k">def</span> <span class="nf">create_raw_line</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="n">ip</span><span class="p">,</span> <span class="n">location</span><span class="p">,</span> <span class="n">identity</span><span class="p">,</span> <span class="n">cookie</span><span class="p">,</span> <span class="n">sep</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Creates a line of raw data corresponding to the raw TSV format.</span>
<span class="sd">    See the `transform_raw_line_to_entity` method to parse such a line to an entity.˚</span>

<span class="sd">    :param device:</span>
<span class="sd">    :param ip:</span>
<span class="sd">    :param location:</span>
<span class="sd">    :param identity:</span>
<span class="sd">    :param cookie:</span>
<span class="sd">    :param sep:</span>
<span class="sd">    :return:</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># the positions not used are kept blank</span>
    <span class="n">ar</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">__raw_keys</span><span class="p">)</span> <span class="o">*</span> <span class="p">[</span><span class="s2">&quot;&quot;</span><span class="p">]</span>
    <span class="n">ar</span><span class="p">[</span><span class="n">__transform_indices</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="n">device</span>
    <span class="n">ar</span><span class="p">[</span><span class="n">__transform_indices</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="n">ip</span>
    <span class="c1"># ar[__transform_indices[2]] = f&quot;&quot;&quot;{{</span>
    <span class="c1">#                                     &quot;data&quot;:[</span>
    <span class="c1">#                                     {{  &quot;schema&quot;:&quot;iglu:com.dbip/location/jsonschema/1-0-0&quot;,</span>
    <span class="c1">#                                         &quot;data&quot;:{{</span>
    <span class="c1">#                                             &quot;city&quot;:{{ &quot;geoname_id&quot;: &quot;{location}&quot;,</span>
    <span class="c1">#                                                     &quot;names&quot;: {{&quot;en&quot;: &quot;{location}&quot;}}</span>
    <span class="c1">#                                                   }}</span>
    <span class="c1">#                                         }}</span>
    <span class="c1">#                                     }}</span>
    <span class="c1">#                                     ]</span>
    <span class="c1">#                                     }}</span>
    <span class="c1">#                                 &quot;&quot;&quot;</span>
    <span class="n">ar</span><span class="p">[</span><span class="n">__transform_indices</span><span class="p">[</span><span class="mi">2</span><span class="p">]]</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span><span class="se">{{</span><span class="s2">&quot;data&quot;:[</span><span class="se">{{</span><span class="s2">  &quot;schema&quot;:&quot;iglu:com.dbip/location/jsonschema/1-0-0&quot;,&quot;data&quot;:</span><span class="se">{{</span><span class="s2">&quot;city&quot;:</span><span class="se">{{</span><span class="s2"> &quot;geoname_id&quot;: &quot;</span><span class="si">{</span><span class="n">location</span><span class="si">}</span><span class="s2">&quot;,&quot;names&quot;: </span><span class="se">{{</span><span class="s2">&quot;en&quot;: &quot;</span><span class="si">{</span><span class="n">location</span><span class="si">}</span><span class="s2">&quot;</span><span class="se">}}}}}}}}</span><span class="s2">]</span><span class="se">}}</span><span class="s2">&quot;&quot;&quot;</span>

    <span class="n">ar</span><span class="p">[</span><span class="n">__transform_indices</span><span class="p">[</span><span class="mi">3</span><span class="p">]]</span> <span class="o">=</span> <span class="n">identity</span>
    <span class="n">ar</span><span class="p">[</span><span class="n">__transform_indices</span><span class="p">[</span><span class="mi">4</span><span class="p">]]</span> <span class="o">=</span> <span class="n">cookie</span>
    <span class="k">return</span> <span class="n">sep</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">ar</span><span class="p">)</span></div>


<div class="viewcode-block" id="get_city_from_string"><a class="viewcode-back" href="../../entity_resolution.html#entity_resolution.data.get_city_from_string">[docs]</a><span class="k">def</span> <span class="nf">get_city_from_string</span><span class="p">(</span><span class="n">ctx</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Parses the city out of the JSON contained in the given string.</span>

<span class="sd">    :param ctx: a string containing JSON.</span>
<span class="sd">    :return: (city id, city name) tuple or (None, None) if not found.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">js</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">ctx</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">js</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">]:</span>
        <span class="k">if</span> <span class="s2">&quot;iglu:com.dbip/location/jsonschema/1-0-0&quot;</span> <span class="o">==</span> <span class="n">j</span><span class="p">[</span><span class="s2">&quot;schema&quot;</span><span class="p">]:</span>
            <span class="k">if</span> <span class="s2">&quot;city&quot;</span> <span class="ow">in</span> <span class="n">j</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">]:</span>
                <span class="n">city_id</span> <span class="o">=</span> <span class="n">j</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">][</span><span class="s2">&quot;city&quot;</span><span class="p">][</span><span class="s2">&quot;geoname_id&quot;</span><span class="p">]</span>
                <span class="n">city_name</span> <span class="o">=</span> <span class="n">j</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">][</span><span class="s2">&quot;city&quot;</span><span class="p">][</span><span class="s2">&quot;names&quot;</span><span class="p">][</span><span class="s2">&quot;en&quot;</span><span class="p">]</span>
                <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">city_id</span><span class="p">),</span> <span class="n">city_name</span>
    <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="transform_raw_line_to_entity"><a class="viewcode-back" href="../../entity_resolution.html#entity_resolution.data.transform_raw_line_to_entity">[docs]</a><span class="k">def</span> <span class="nf">transform_raw_line_to_entity</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="n">sep</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Turns the raw TSV line into an entity.</span>

<span class="sd">    :param line: the TSV line</span>
<span class="sd">    :param sep: the separator</span>
<span class="sd">    :return: an entity</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">ha</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">get_raw_keys</span><span class="p">())</span>
    <span class="n">device_position</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argwhere</span><span class="p">(</span><span class="n">ha</span> <span class="o">==</span> <span class="s2">&quot;DOMAIN_USERID&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">identity_position</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argwhere</span><span class="p">(</span><span class="n">ha</span> <span class="o">==</span> <span class="s2">&quot;USER_ID&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">cookie_position</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argwhere</span><span class="p">(</span><span class="n">ha</span> <span class="o">==</span> <span class="s2">&quot;NETWORK_USERID&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">ip_position</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argwhere</span><span class="p">(</span><span class="n">ha</span> <span class="o">==</span> <span class="s2">&quot;USER_IPADDRESS&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">context_position</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argwhere</span><span class="p">(</span><span class="n">ha</span> <span class="o">==</span> <span class="s2">&quot;DERIVED_CONTEXTS&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">line</span><span class="p">)</span> <span class="o">==</span> <span class="nb">bytes</span><span class="p">:</span>
        <span class="n">values</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">sep</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">values</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">sep</span><span class="p">)</span>
    <span class="n">device</span> <span class="o">=</span> <span class="nb">str</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="n">values</span><span class="p">[</span><span class="n">device_position</span><span class="p">])</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">device</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="kc">None</span>
    <span class="n">identity</span> <span class="o">=</span> <span class="n">values</span><span class="p">[</span><span class="n">identity_position</span><span class="p">]</span>
    <span class="n">ip</span> <span class="o">=</span> <span class="n">values</span><span class="p">[</span><span class="n">ip_position</span><span class="p">]</span>
    <span class="n">cookie</span> <span class="o">=</span> <span class="n">values</span><span class="p">[</span><span class="n">cookie_position</span><span class="p">]</span>
    <span class="n">ctx</span> <span class="o">=</span> <span class="n">values</span><span class="p">[</span><span class="n">context_position</span><span class="p">]</span>
    <span class="n">location</span> <span class="o">=</span> <span class="n">get_city_from_string</span><span class="p">(</span><span class="n">ctx</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">entity</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">__transform_keys</span><span class="p">,</span> <span class="p">[</span><span class="n">device</span><span class="p">,</span> <span class="n">ip</span><span class="p">,</span> <span class="n">location</span><span class="p">,</span> <span class="n">identity</span><span class="p">,</span> <span class="n">cookie</span><span class="p">])}</span>
    <span class="c1"># print([device_position, ip_position, context_position, identity_position, cookie_position])</span>
    <span class="k">return</span> <span class="n">entity</span></div>


<div class="viewcode-block" id="raw_to_entities_json"><a class="viewcode-back" href="../../entity_resolution.html#entity_resolution.data.raw_to_entities_json">[docs]</a><span class="k">def</span> <span class="nf">raw_to_entities_json</span><span class="p">(</span><span class="n">raw_directory</span><span class="p">,</span> <span class="n">output_directory</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Transforms the data contained as gzip files in the given directory to JSON entity in another directory.</span>

<span class="sd">    :param raw_directory:</span>
<span class="sd">    :param output_directory:</span>
<span class="sd">    :return:</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">ha</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">get_raw_keys</span><span class="p">())</span>
    <span class="n">device_position</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argwhere</span><span class="p">(</span><span class="n">ha</span> <span class="o">==</span> <span class="s2">&quot;DOMAIN_USERID&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">identity_position</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argwhere</span><span class="p">(</span><span class="n">ha</span> <span class="o">==</span> <span class="s2">&quot;USER_ID&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">cookie_position</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argwhere</span><span class="p">(</span><span class="n">ha</span> <span class="o">==</span> <span class="s2">&quot;NETWORK_USERID&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">ip_position</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argwhere</span><span class="p">(</span><span class="n">ha</span> <span class="o">==</span> <span class="s2">&quot;USER_IPADDRESS&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">context_position</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argwhere</span><span class="p">(</span><span class="n">ha</span> <span class="o">==</span> <span class="s2">&quot;DERIVED_CONTEXTS&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>

    <span class="c1"># print(device_position, identity_position, cookie_position, ip_position, context_position)</span>


    <span class="n">coll</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="n">files</span> <span class="o">=</span> <span class="n">get_files</span><span class="p">(</span><span class="n">raw_directory</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Reading </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">files</span><span class="p">)</span><span class="si">}</span><span class="s2"> file(s) in directory &#39;</span><span class="si">{</span><span class="n">raw_directory</span><span class="si">}</span><span class="s2">&#39;.&quot;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">file_path</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">files</span><span class="p">):</span>

        <span class="k">with</span> <span class="n">gzip</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">lines</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">line</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">lines</span><span class="p">):</span>
                <span class="n">values</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">device</span> <span class="o">=</span> <span class="nb">str</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="n">values</span><span class="p">[</span><span class="n">device_position</span><span class="p">])</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">device</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="n">identity</span> <span class="o">=</span> <span class="n">values</span><span class="p">[</span><span class="n">identity_position</span><span class="p">]</span>
                <span class="n">ip</span> <span class="o">=</span> <span class="n">values</span><span class="p">[</span><span class="n">ip_position</span><span class="p">]</span>
                <span class="n">cookie</span> <span class="o">=</span> <span class="n">values</span><span class="p">[</span><span class="n">cookie_position</span><span class="p">]</span>
                <span class="n">ctx</span> <span class="o">=</span> <span class="n">values</span><span class="p">[</span><span class="n">context_position</span><span class="p">]</span>
                <span class="n">location</span> <span class="o">=</span> <span class="n">get_city_from_string</span><span class="p">(</span><span class="n">ctx</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">entity</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">__transform_keys</span><span class="p">,</span> <span class="p">[</span><span class="n">device</span><span class="p">,</span> <span class="n">ip</span><span class="p">,</span> <span class="n">location</span><span class="p">,</span> <span class="n">identity</span><span class="p">,</span> <span class="n">cookie</span><span class="p">])}</span>
                <span class="n">coll</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">entity</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">output_directory</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># ensure the directory is there</span>
        <span class="n">Path</span><span class="p">(</span><span class="n">output_directory</span><span class="p">)</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>

        <span class="n">local_dir</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">output_directory</span><span class="p">)</span>
        <span class="n">output_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">local_dir</span><span class="p">,</span> <span class="s1">&#39;raw.json&#39;</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">output_path</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">coll</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Written to &quot;</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">local_dir</span><span class="p">,</span> <span class="s1">&#39;raw.json&#39;</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">coll</span></div>


<div class="viewcode-block" id="get_files"><a class="viewcode-back" href="../../entity_resolution.html#entity_resolution.data.get_files">[docs]</a><span class="k">def</span> <span class="nf">get_files</span><span class="p">(</span><span class="n">directory</span><span class="p">,</span> <span class="n">pattern</span> <span class="o">=</span> <span class="s2">&quot;*.gz&quot;</span><span class="p">,</span> <span class="n">full_path</span> <span class="o">=</span> <span class="kc">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns the files in the specified directory.</span>

<span class="sd">    :param directory: the directory to scan</span>
<span class="sd">    :param pattern: the file extension, default &#39;*.gz&#39;.</span>
<span class="sd">    :param full_path: if True the full path to the files is retured, otherwise just the name.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">files</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">directory</span><span class="p">,</span> <span class="s2">&quot;*.gz&quot;</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">full_path</span><span class="p">:</span>
        <span class="n">files</span> <span class="o">=</span> <span class="p">[</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">directory</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">files</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">files</span></div>


<div class="viewcode-block" id="graph_to_raw"><a class="viewcode-back" href="../../entity_resolution.html#entity_resolution.data.graph_to_raw">[docs]</a><span class="k">def</span> <span class="nf">graph_to_raw</span><span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="n">raw_directory</span><span class="p">,</span> <span class="n">lines_per_file</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Fills a directory with gzip files corresponding to the raw format.</span>

<span class="sd">    :param g: the graph</span>
<span class="sd">    :param raw_directory: the destination</span>
<span class="sd">    :param lines_per_file: how many lines per file (per gzip file)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># ensure the directory is there</span>
    <span class="n">Path</span><span class="p">(</span><span class="n">raw_directory</span><span class="p">)</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
    <span class="n">coll</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="n">file_number</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">e</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">edges</span><span class="p">()):</span>
        <span class="n">entity</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;Device&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
            <span class="s2">&quot;IP&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Identity&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Location&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Cookie&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span>
        <span class="p">}</span>
        <span class="n">u</span><span class="p">,</span> <span class="n">v</span> <span class="o">=</span> <span class="n">e</span>
        <span class="n">source</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">nodes</span><span class="p">()[</span><span class="n">u</span><span class="p">]</span>
        <span class="n">target</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">nodes</span><span class="p">()[</span><span class="n">v</span><span class="p">]</span>
        <span class="n">entity</span><span class="p">[</span><span class="n">source</span><span class="p">[</span><span class="s2">&quot;label&quot;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">source</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]</span>
        <span class="n">entity</span><span class="p">[</span><span class="n">target</span><span class="p">[</span><span class="s2">&quot;label&quot;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">target</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]</span>
        <span class="n">entity</span> <span class="o">=</span> <span class="p">{</span><span class="nb">str</span><span class="o">.</span><span class="n">lower</span><span class="p">(</span><span class="n">k</span><span class="p">):</span> <span class="n">entity</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">entity</span><span class="p">}</span>
        <span class="n">line</span> <span class="o">=</span> <span class="n">create_raw_line</span><span class="p">(</span><span class="o">**</span><span class="n">entity</span><span class="p">)</span>
        <span class="n">coll</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">i</span> <span class="o">%</span> <span class="n">lines_per_file</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">file_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">raw_directory</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;data</span><span class="si">{</span><span class="n">file_number</span><span class="si">}</span><span class="s2">.gz&quot;</span><span class="p">)</span>
            <span class="n">file_number</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">with</span> <span class="n">gzip</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">coll</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span>
            <span class="n">coll</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">coll</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">file_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">raw_directory</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;data</span><span class="si">{</span><span class="n">file_number</span><span class="si">}</span><span class="s2">.gz&quot;</span><span class="p">)</span>
        <span class="k">with</span> <span class="n">gzip</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">coll</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Written </span><span class="si">{</span><span class="n">file_number</span><span class="si">}</span><span class="s2"> file(s) in &#39;</span><span class="si">{</span><span class="n">raw_directory</span><span class="si">}</span><span class="s2">&#39;.&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="raw_to_graph"><a class="viewcode-back" href="../../entity_resolution.html#entity_resolution.data.raw_to_graph">[docs]</a><span class="k">def</span> <span class="nf">raw_to_graph</span><span class="p">(</span><span class="n">raw_directory</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns the graph contained in the directory with the raw files.</span>

<span class="sd">    :param json_data:</span>
<span class="sd">    :return:</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">entities_json</span> <span class="o">=</span> <span class="n">raw_to_entities_json</span><span class="p">(</span><span class="n">raw_directory</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">entities_json_to_graph</span><span class="p">(</span><span class="n">entities_json</span><span class="p">)</span></div>


<div class="viewcode-block" id="entities_json_to_graph"><a class="viewcode-back" href="../../entity_resolution.html#entity_resolution.data.entities_json_to_graph">[docs]</a><span class="k">def</span> <span class="nf">entities_json_to_graph</span><span class="p">(</span><span class="n">entities_json</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Turns the given set of entities to a graph.</span>

<span class="sd">    :param entities_json: the array of entities</span>
<span class="sd">    :return: a graph</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">device_nodes</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">ip_nodes</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">location_nodes</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">identity_nodes</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">cookie_nodes</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">label_dic</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;Device&quot;</span><span class="p">:</span> <span class="n">device_nodes</span><span class="p">,</span> <span class="s2">&quot;IP&quot;</span><span class="p">:</span> <span class="n">ip_nodes</span><span class="p">,</span> <span class="s2">&quot;Location&quot;</span><span class="p">:</span> <span class="n">location_nodes</span><span class="p">,</span> <span class="s2">&quot;Identity&quot;</span><span class="p">:</span> <span class="n">identity_nodes</span><span class="p">,</span> <span class="s2">&quot;Cookie&quot;</span><span class="p">:</span> <span class="n">cookie_nodes</span><span class="p">}</span>
    <span class="n">g</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">DiGraph</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">get_node_index</span><span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="nb">id</span><span class="p">):</span>
        <span class="nb">id</span> <span class="o">=</span> <span class="nb">str</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="nb">str</span><span class="o">.</span><span class="n">lower</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="nb">id</span><span class="p">)))</span>
        <span class="k">if</span> <span class="nb">id</span> <span class="o">==</span> <span class="s2">&quot;nan&quot;</span> <span class="ow">or</span> <span class="nb">id</span> <span class="o">==</span> <span class="s2">&quot;none&quot;</span> <span class="ow">or</span> <span class="nb">id</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="n">dic</span> <span class="o">=</span> <span class="n">label_dic</span><span class="p">[</span><span class="n">label</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">id</span> <span class="ow">in</span> <span class="n">dic</span><span class="p">:</span>
            <span class="n">i</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">nodes</span><span class="p">())</span>
            <span class="n">g</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="n">label</span><span class="p">,</span> <span class="nb">id</span> <span class="o">=</span> <span class="nb">id</span><span class="p">)</span>
            <span class="n">dic</span><span class="p">[</span><span class="nb">id</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span>
            <span class="c1"># # case of a Device there is always a Cookie with the same id</span>
            <span class="c1"># if label == &quot;Device&quot;:</span>
            <span class="c1">#     j = len(g.nodes())</span>
            <span class="c1">#     g.add_node(j, label = &quot;Cookie&quot;, id = id)</span>
            <span class="c1">#     g.add_edge(i, j, label = &quot;HAS_COOKIE&quot;)</span>
        <span class="k">return</span> <span class="n">dic</span><span class="p">[</span><span class="nb">id</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">connect</span><span class="p">(</span><span class="n">device_index</span><span class="p">,</span> <span class="n">target_label</span><span class="p">,</span> <span class="n">target_index</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">target_index</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="n">g</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="n">device_index</span><span class="p">,</span> <span class="n">target_index</span><span class="p">,</span>
                   <span class="n">label</span> <span class="o">=</span> <span class="s2">&quot;HAS_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="o">.</span><span class="n">upper</span><span class="p">(</span><span class="n">target_label</span><span class="p">))</span>

    <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">entities_json</span><span class="p">:</span>
        <span class="n">device_index</span> <span class="o">=</span> <span class="n">get_node_index</span><span class="p">(</span><span class="s2">&quot;Device&quot;</span><span class="p">,</span> <span class="n">r</span><span class="p">[</span><span class="s2">&quot;Device&quot;</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">device_index</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;oops, no device index here&quot;</span><span class="p">)</span>
            <span class="c1"># raise Exception(&quot;Device with nil id&quot;)</span>
            <span class="k">continue</span>
        <span class="n">ip_index</span> <span class="o">=</span> <span class="n">get_node_index</span><span class="p">(</span><span class="s2">&quot;IP&quot;</span><span class="p">,</span> <span class="n">r</span><span class="p">[</span><span class="s2">&quot;IP&quot;</span><span class="p">])</span>
        <span class="n">location_index</span> <span class="o">=</span> <span class="n">get_node_index</span><span class="p">(</span><span class="s2">&quot;Location&quot;</span><span class="p">,</span> <span class="n">r</span><span class="p">[</span><span class="s2">&quot;Location&quot;</span><span class="p">])</span>
        <span class="n">identity_index</span> <span class="o">=</span> <span class="n">get_node_index</span><span class="p">(</span><span class="s2">&quot;Identity&quot;</span><span class="p">,</span> <span class="n">r</span><span class="p">[</span><span class="s2">&quot;Identity&quot;</span><span class="p">])</span>
        <span class="n">cookie_index</span> <span class="o">=</span> <span class="n">get_node_index</span><span class="p">(</span><span class="s2">&quot;Cookie&quot;</span><span class="p">,</span> <span class="n">r</span><span class="p">[</span><span class="s2">&quot;Cookie&quot;</span><span class="p">])</span>

        <span class="n">connect</span><span class="p">(</span><span class="n">device_index</span><span class="p">,</span> <span class="s2">&quot;IP&quot;</span><span class="p">,</span> <span class="n">ip_index</span><span class="p">)</span>
        <span class="n">connect</span><span class="p">(</span><span class="n">device_index</span><span class="p">,</span> <span class="s2">&quot;Location&quot;</span><span class="p">,</span> <span class="n">location_index</span><span class="p">)</span>
        <span class="n">connect</span><span class="p">(</span><span class="n">device_index</span><span class="p">,</span> <span class="s2">&quot;Identity&quot;</span><span class="p">,</span> <span class="n">identity_index</span><span class="p">)</span>
        <span class="n">connect</span><span class="p">(</span><span class="n">device_index</span><span class="p">,</span> <span class="s2">&quot;Cookie&quot;</span><span class="p">,</span> <span class="n">cookie_index</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">g</span></div>


<div class="viewcode-block" id="graph_to_entities_json"><a class="viewcode-back" href="../../entity_resolution.html#entity_resolution.data.graph_to_entities_json">[docs]</a><span class="k">def</span> <span class="nf">graph_to_entities_json</span><span class="p">(</span><span class="n">g</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Converts the given graph to entities JSON.</span>
<span class="sd">    :param g: a graph</span>
<span class="sd">    :return: an array of JSON</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">entities</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">u</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">g</span><span class="o">.</span><span class="n">edges</span><span class="p">():</span>
        <span class="n">entity</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;Device&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
            <span class="s2">&quot;IP&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Identity&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Location&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Cookie&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span>
        <span class="p">}</span>
        <span class="n">source</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">nodes</span><span class="p">()[</span><span class="n">u</span><span class="p">]</span>
        <span class="n">target</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">nodes</span><span class="p">()[</span><span class="n">v</span><span class="p">]</span>
        <span class="n">entity</span><span class="p">[</span><span class="n">source</span><span class="p">[</span><span class="s2">&quot;label&quot;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">source</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]</span>
        <span class="n">entity</span><span class="p">[</span><span class="n">target</span><span class="p">[</span><span class="s2">&quot;label&quot;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">target</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]</span>
        <span class="n">entities</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">entity</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">entities</span></div>


<div class="viewcode-block" id="download_s3_folder"><a class="viewcode-back" href="../../entity_resolution.html#entity_resolution.data.download_s3_folder">[docs]</a><span class="k">def</span> <span class="nf">download_s3_folder</span><span class="p">(</span><span class="n">s3_uri</span> <span class="o">=</span> <span class="s2">&quot;s3://your-thing/your-bucket/&quot;</span><span class="p">,</span> <span class="n">local_dir</span> <span class="o">=</span> <span class="s2">&quot;./raw&quot;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Download the s3 contents of a folder.</span>
<span class="sd">    Note that you need to have aws configured (aws configure in terminal).</span>

<span class="sd">    Use for example</span>
<span class="sd">        `download_s3_folder(&quot;s3://your-thing/your-bucket&quot;, &quot;~/temp/bucket&quot;)`</span>

<span class="sd">    :param s3_uri:the s3 uri to the top level of the files you wish to download</span>
<span class="sd">    :param local_dir:a relative or absolute directory path in the local file system</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">s3</span> <span class="o">=</span> <span class="n">boto3</span><span class="o">.</span><span class="n">resource</span><span class="p">(</span><span class="s2">&quot;s3&quot;</span><span class="p">)</span>
    <span class="n">bucket</span> <span class="o">=</span> <span class="n">s3</span><span class="o">.</span><span class="n">Bucket</span><span class="p">(</span><span class="n">urlparse</span><span class="p">(</span><span class="n">s3_uri</span><span class="p">)</span><span class="o">.</span><span class="n">hostname</span><span class="p">)</span>
    <span class="n">s3_path</span> <span class="o">=</span> <span class="n">urlparse</span><span class="p">(</span><span class="n">s3_uri</span><span class="p">)</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">lstrip</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">local_dir</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">local_dir</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">local_dir</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="n">bucket</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">Prefix</span> <span class="o">=</span> <span class="n">s3_path</span><span class="p">):</span>
        <span class="n">target</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">key</span> <span class="k">if</span> <span class="n">local_dir</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">local_dir</span> <span class="o">/</span> <span class="n">Path</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">key</span><span class="p">)</span><span class="o">.</span><span class="n">relative_to</span><span class="p">(</span><span class="n">s3_path</span><span class="p">)</span>
        <span class="n">target</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">obj</span><span class="o">.</span><span class="n">key</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;/&#39;</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="n">bucket</span><span class="o">.</span><span class="n">download_file</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">key</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">target</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">key</span><span class="p">)</span></div>


<div class="viewcode-block" id="create_neo_database"><a class="viewcode-back" href="../../entity_resolution.html#entity_resolution.data.create_neo_database">[docs]</a><span class="k">def</span> <span class="nf">create_neo_database</span><span class="p">(</span><span class="n">db_name</span> <span class="o">=</span> <span class="s2">&quot;newDatabase&quot;</span><span class="p">,</span> <span class="n">uri</span> <span class="o">=</span> <span class="s2">&quot;bolt://localhost:7687&quot;</span><span class="p">,</span> <span class="n">user</span> <span class="o">=</span> <span class="s2">&quot;neo4j&quot;</span><span class="p">,</span> <span class="n">password</span> <span class="o">=</span> <span class="s2">&quot;123&quot;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Creates a new Neo4j database.</span>

<span class="sd">    :param db_name: the name of the datbase</span>
<span class="sd">    :param uri: the Bolt Url to Neo4j</span>
<span class="sd">    :param user: the user name</span>
<span class="sd">    :param password: the password</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">neo</span> <span class="o">=</span> <span class="n">Neo</span><span class="p">(</span><span class="n">uri</span><span class="p">,</span> <span class="n">user</span><span class="p">,</span> <span class="n">password</span><span class="p">)</span>
    <span class="n">neo</span><span class="o">.</span><span class="n">create_database</span><span class="p">(</span><span class="n">db_name</span><span class="p">)</span></div>


<div class="viewcode-block" id="delete_neo_database"><a class="viewcode-back" href="../../entity_resolution.html#entity_resolution.data.delete_neo_database">[docs]</a><span class="k">def</span> <span class="nf">delete_neo_database</span><span class="p">(</span><span class="n">db_name</span> <span class="o">=</span> <span class="s2">&quot;newDatabase&quot;</span><span class="p">,</span> <span class="n">uri</span> <span class="o">=</span> <span class="s2">&quot;bolt://localhost:7687&quot;</span><span class="p">,</span> <span class="n">user</span> <span class="o">=</span> <span class="s2">&quot;neo4j&quot;</span><span class="p">,</span> <span class="n">password</span> <span class="o">=</span> <span class="s2">&quot;123&quot;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Deletes the specified database.</span>

<span class="sd">    :param db_name: the name of the datbase</span>
<span class="sd">    :param uri: the Bolt Url to Neo4j</span>
<span class="sd">    :param user: the user name</span>
<span class="sd">    :param password: the password</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">neo</span> <span class="o">=</span> <span class="n">Neo</span><span class="p">()</span>
    <span class="n">neo</span><span class="o">.</span><span class="n">delete_database</span><span class="p">(</span><span class="n">db_name</span><span class="p">)</span></div>


<div class="viewcode-block" id="graph_to_neo"><a class="viewcode-back" href="../../entity_resolution.html#entity_resolution.data.graph_to_neo">[docs]</a><span class="k">def</span> <span class="nf">graph_to_neo</span><span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="n">db_name</span> <span class="o">=</span> <span class="s2">&quot;newDatabase&quot;</span><span class="p">,</span> <span class="n">uri</span> <span class="o">=</span> <span class="s2">&quot;bolt://localhost:7687&quot;</span><span class="p">,</span> <span class="n">user</span> <span class="o">=</span> <span class="s2">&quot;neo4j&quot;</span><span class="p">,</span> <span class="n">password</span> <span class="o">=</span> <span class="s2">&quot;123&quot;</span><span class="p">,</span> <span class="n">clear_content</span> <span class="o">=</span> <span class="kc">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Transfers the given graph to Neo4j.</span>


<span class="sd">    :param g: the graph</span>
<span class="sd">    :param db_name: the name of the datbase</span>
<span class="sd">    :param uri: the Bolt Url to Neo4j</span>
<span class="sd">    :param user: the user name</span>
<span class="sd">    :param password: the password</span>
<span class="sd">    :param clear_content: whether the database should be truncated before adding the graph</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">neo</span> <span class="o">=</span> <span class="n">Neo</span><span class="p">(</span><span class="n">uri</span><span class="p">,</span> <span class="n">user</span><span class="p">,</span> <span class="n">password</span><span class="p">)</span>
    <span class="n">neo</span><span class="o">.</span><span class="n">write_graph</span><span class="p">(</span><span class="n">db_name</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">clear_content</span><span class="p">)</span></div>


<div class="viewcode-block" id="get_chunks"><a class="viewcode-back" href="../../entity_resolution.html#entity_resolution.data.get_chunks">[docs]</a><span class="k">def</span> <span class="nf">get_chunks</span><span class="p">(</span><span class="n">lst</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">     Yield successive n-sized chunks from lst.</span>

<span class="sd">     :param lst: a list</span>
<span class="sd">     :param n: the size of the chunks</span>

<span class="sd">     &quot;&quot;&quot;</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">lst</span><span class="p">),</span> <span class="n">n</span><span class="p">):</span>
        <span class="k">yield</span> <span class="n">lst</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span> <span class="o">+</span> <span class="n">n</span><span class="p">]</span></div>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2022, Orbifold Consulting.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>